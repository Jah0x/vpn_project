# Аутентификация через Telegram

В проекте предусмотрена возможность входа без пароля с помощью Telegram Web App. Компонент `TelegramLogin` теперь отправляет на сервер строку `window.Telegram.WebApp.initData` без разбора на поля.

> **Важно.** Эндпоинт `/api/auth/telegram` доступен только на поддомене `tg.zerologsvpn.com`. На основном домене `zerologsvpn.com` используется классическая авторизация по логину и паролю.

Таким образом сервер получает полный набор полей от Telegram, проверяет подпись и создаёт (либо находит) пользователя, после чего выдаёт JWT.

Чтобы использовать этот способ:
1. Внутри Telegram Bot необходимо настроить Web App и передать URL в `index.html`.
2. Пользователь открывает бот, кликает кнопку "Войти" и передает данные в Web App.
3. После первого входа новый пользователь заполняет недостающие данные в форме и отправляет их на бекенд.
4. Сервер создает аккаунт и возвращает токен. В дальнейшем повторный вход выполняется автоматически, без ввода пароля.

При загрузке страницы вызывается функция `bootstrapFromTelegram`, которая
сохраняет полученный `initData` в `localStorage`, отправляет событие
`telegram-initialized` и уведомляет контейнер Telegram о готовности. Это
ускоряет авторизацию в mini-app и снимает необходимость размещать инлайн
скрипты в `index.html`.

Схема авторизации через Telegram дополнительно описана в backend `server/src/services` и может быть расширена.

## Отладка

После добавления логирования каждая попытка входа через Telegram отображается в консоли сервера. В логе будут строки вида:

```json
{"level":30,"msg":"Telegram auth attempt","telegramId":"123456"}
```

Если сообщения не появляются, убедитесь, что переменная окружения `TELEGRAM_BOT_TOKEN` задана и сервер перезапущен.
При запуске backend дополнительно печатается `TELEGRAM_BOT_TOKEN=...`, что позволяет убедиться в доступности переменной.

Начиная с версии от 2025‑10‑02, запросы к `/api/auth/telegram` стали идемпотентными. Сервер кэширует пару токенов по `hash` из `initData` и возвращает одни и те же значения при повторной отправке того же payload. Также действует лимит 5 запросов за 10 секунд по IP.

С 2025-10-04 при превышении лимита сервер возвращает 429, а мини-приложение показывает кнопку 'Повторить', чтобы избежать бесконечного цикла запросов.
